name: Build, Test and Push Docker image

on:
  push:
    branches: [ main ]

jobs:
  build-test-push:
    runs-on: ubuntu-latest
    services:
      sqlserver:
        image: exoplatform/sqlserver:latest
        env:
          SA_PASSWORD: Admin123!
          ACCEPT_EULA: "Y"
          SQLSERVER_DATABASE: AppCustomerDiiageDbe
          SQLSERVER_USER: sa
          SQLSERVER_PASSWORD: Admin123!
        ports:
          - 1433:1433
    steps:
      - uses: actions/checkout@v4

      - name: Wait for SQL Server to be ready
        run: |
          for i in {1..30}; do
            if nc -z sqlserver 1433; then
              echo "SQL Server is up!"
              break
            fi
            echo "Waiting for SQL Server..."
            sleep 2
          done

      - name: Build Docker image
        run: docker build -t docker.io/ttmartinksdocket/tp3-web:latest .

      - name: Test Docker image
        run: |
          docker run --rm \
            -e ConnectionStrings__DefaultConnection="Server=sqlserver,1433;Database=AppCustomerDiiageDbe;User=sa;Password=Admin123!;TrustServerCertificate=True;" \
            docker.io/ttmartinksdocket/tp3-web:latest dotnet --info

      - name: Login to Docker Hub
        run: echo "${{ secrets.REGISTRY_PASSWORD }}" | docker login docker.io -u "${{ secrets.REGISTRY_USER }}" --password-stdin

      - name: Push Docker image
        run: docker push docker.io/ttmartinksdocket/tp3-web:latest
